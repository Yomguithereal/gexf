/* gexf-writer.js - Gexf writer for JavaScript. - Version: 0.2.2 - Author: Guillaume Plique - medialab SciencesPo */
(function(e){"use strict";function t(e,t){switch(e){case"boolean":case"integer":case"long":case"float":case"double":return""+t;case"liststring":if(t instanceof Array)return t.join("|")}if("object"==typeof t)throw Error("gexf.writer.cast: trying to cast an object to a string.");return t}function i(e){var t=[0,0,0];return e.match(/^#/)?(e=(e||"").replace(/^#/,""),t=3===e.length?[parseInt(e.charAt(0)+e.charAt(0),16),parseInt(e.charAt(1)+e.charAt(1),16),parseInt(e.charAt(2)+e.charAt(2),16)]:[parseInt(e.charAt(0)+e.charAt(1),16),parseInt(e.charAt(2)+e.charAt(3),16),parseInt(e.charAt(4)+e.charAt(5),16)]):e.match(/^ *rgba? *\(/)&&(e=e.match(/^ *rgba? *\( *([0-9]*) *, *([0-9]*) *, *([0-9]*) *(,.*)?\) *$/),t=[+e[1],+e[2],+e[3]],e[4]&&t.push(+e[4].replace(", ",""))),t}function r(t){t=t||{};var i=t.implementation||e.implementation;this.serializer=t.serializer?new t.serializer:new XMLSerializer,this.document=i.createDocument("http://www.gexf.net/1.2draft","gexf",null),this.root=this.document.documentElement,this.xmlns=t.namespace||"http://www.gexf.net/1.2draft",this.vizXmlns=t.vizNamespace||"http:///www.gexf.net/1.2draft/viz",this.root.setAttribute("xmlns",this.xmlns),this.root.setAttribute("xmlns:xsi","http://www.w3.org/2001/XMLSchema-instance"),this.root.setAttribute("xsi:schemaLocation","http://www.gexf.net/1.2draft http://www.gexf.net/1.2draft/gexf.xsd"),this.hasViz=!1,this.root.setAttribute("version",t.version||"1.2"),this.encoding=t.encoding||"UTF-8",t.meta&&this.setMeta(t.meta),this.graph=this.createElement("graph",{defaultedgetype:t.defaultEdgeType||"undirected",mode:t.mode}),this.root.appendChild(this.graph),this.models={node:{},edge:{}},this.nodeAttributes=null,this.edgeAttributes=null,t.models&&t.models.node&&this.setNodeModel(t.models.node),t.models&&t.models.edge&&this.setEdgeModel(t.models.edge),this.nodes=this.createElement("nodes"),this.edges=this.createElement("edges"),this.graph.appendChild(this.nodes),this.graph.appendChild(this.edges);var r,s;if(t.nodes)for(r=0,s=t.nodes.length;s>r;r++)this.addNode(t.nodes[r]);if(t.edges)for(r=0,s=t.edges.length;s>r;r++)this.addEdge(t.edges[r])}function s(e){return new r(e)}var n=["integer","long","double","float","boolean","liststring","string","anyURI"];r.prototype.createElement=function(e,t,i){if(!e)throw Error("gexf.writer.createElement: wrong arguments.");"object"==typeof t&&(i=t,t=null);var r=this.document.createElement(e);if(t){var s=this.document.createTextNode(t);r.appendChild(s)}if(i)for(var n in i)"undefined"!=typeof i[n]&&null!==i[n]&&r.setAttribute(n,i[n]);return r},r.prototype.setMeta=function(e){e=e||{};var t,i=this.document.createElement("meta");for(t in e)"lastmodifieddate"===t?i.setAttribute("lastmodifieddate",e[t]):i.appendChild(this.createElement(t,e[t]));return this.root.appendChild(i),this},r.prototype.setModel=function(e,t){if(t=t||[],"node"!==e&&"edge"!==e)throw Error('gexf.writer.setModel: wrong model cls "'+e+'"');if(!(t instanceof Array))throw Error("gexf.writer.setModel: model is not a valid array.");this.models[e]={};var i=this.createElement("attributes",{"class":e}),r=e+"Attributes";this[r]&&this.graph.removeChild(this[r]),this[r]=i,this.graph.insertBefore(i,this.nodes||this.edges);var s,n;for(s=0,n=t.length;n>s;s++)this.addAttribute(e,t[s]);return this},r.prototype.setNodeModel=function(e){return this.setModel("node",e)},r.prototype.setEdgeModel=function(e){return this.setModel("edge",e)},r.prototype.addAttribute=function(e,t){if("node"!==e&&"edge"!==e)throw Error('gexf.writer.addAttribute: wrong model cls "'+e+'"');if(!t)throw Error("gexf.writer.addAttribute: wrong arguments.");if(!this[e+"Attributes"])return this.setModel(e,[t]);var i=t.type||"string";if(!~n.indexOf(i))throw Error('gexf.writer.addAttribute: unknown attribute type "'+i+'"');this.models[e][t.id]=t;var r=this.createElement("attribute",{id:t.id,title:t.title,type:i});if("undefined"!=typeof t.defaultValue){var s=this.createElement("default",t.defaultValue);r.appendChild(s)}return this[e+"Attributes"].appendChild(r),this},r.prototype.addNodeAttribute=function(e){return this.addAttribute("node",e)},r.prototype.addEdgeAttribute=function(e){return this.addAttribute("edge",e)},r.prototype.addNode=function(e){var r,s,n;if("undefined"==typeof e.id||null===e.id)throw Error("gexf.writer.addNode: inexistent id.");var o=this.createElement("node",{id:e.id,label:e.label});if(e.attributes&&Object.keys(e.attributes).length>0){var a=this.createElement("attvalues");for(r in e.attributes||{}){if(s=e.attributes[r],n=this.models.node[r],!n)throw Error('gexf.writer.addNode: property "'+r+'" not registered in node model.');var d=this.createElement("attvalue",{"for":n.id,value:t(n.type,s)});a.appendChild(d)}o.appendChild(a)}if(e.viz){if(this.hasViz||(this.hasViz=!0,this.root.setAttribute("xmlns:viz",this.vizXmlns)),e.viz.color){var h=i(e.viz.color),l=this.createElement("viz:color",{r:h[0],g:h[1],b:h[2],a:h[3]});o.appendChild(l)}if(e.viz.position){var p=this.createElement("viz:position",{x:e.viz.position.x,y:e.viz.position.y,z:e.viz.position.z});o.appendChild(p)}if(e.viz.size){var u=this.createElement("viz:size",{value:e.viz.size});o.appendChild(u)}if(e.viz.shape){var c=this.createElement("viz:shape",{value:e.viz.shape});o.appendChild(c)}}return this.nodes.appendChild(o),this},r.prototype.addEdge=function(e){var r,s,n,o=this.createElement("edge",{id:e.id,label:e.label,weigth:e.weight,type:e.type,source:e.source,target:e.target});if(e.attributes&&Object.keys(e.attributes).length>0){var a=this.createElement("attvalues");for(r in e.attributes||{}){if(s=e.attributes[r],n=this.models.edge[r],!n)throw Error('gexf.writer.addEdge: property "'+r+'" not registered in edge model.');var d=this.createElement("attvalue",{"for":n.id,value:t(n.type,s)});a.appendChild(d)}o.appendChild(a)}if(e.viz){if(this.hasViz||(this.hasViz=!0,this.root.setAttribute("xmlns:viz",this.vizXmlns)),e.viz.color){var h=i(e.viz.color),l=this.createElement("viz:color",{r:h[0],g:h[1],b:h[2],a:h[3]});o.appendChild(l)}if(e.viz.shape){var p=this.createElement("viz:shape",{value:e.viz.shape});o.appendChild(p)}if(e.viz.thickness){var u=this.createElement("viz:thickness",{value:e.viz.shape});o.appendChild(u)}}return this.edges.appendChild(o),this},r.prototype.serialize=function(){return'<?xml version="1.0" encoding="'+this.encoding+'"?>'+this.serializer.serializeToString(this.document)};var o={create:s,version:"0.2.2"};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=o),exports.gexf=o):"function"==typeof define&&define.amd?define("gexf",[],function(){return o}):"undefined"!=typeof this.gexf?this.gexf.create=s:this.gexf=o}).call(this,"document"in this?this.document:{});